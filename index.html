<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>AA åˆ†å¸³è¨ˆç®—å™¨ï¼ˆGoogle Drive å…±ç”¨ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;margin:20px;background:#f9f9f9;}
h2{text-align:center;color:#333;}
.container{max-width:700px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
.person{border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:5px;}
.inputs,.detail-input{display:flex;gap:10px;margin-bottom:5px;}
input{flex:1;padding:5px;font-size:14px;}
button{padding:5px 10px;font-size:14px;cursor:pointer;border:none;border-radius:5px;background:#007bff;color:white;}
button:hover{background:#0056b3;}
.remove-btn{background:#dc3545;}
.remove-btn:hover{background:#a71d2a;}
.result{margin-top:15px;background:#f1f1f1;padding:10px;border-radius:5px;white-space:pre-line;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:5px;text-align:center;}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
</style>
</head>
<body>
<div class="container">
<h2>AA åˆ†å¸³è¨ˆç®—å™¨ï¼ˆGoogle Drive å…±ç”¨ç‰ˆï¼‰</h2>
<div id="inputs"></div>
<div class="controls">
<button onclick="addPerson()">ï¼‹å¢åŠ ä¸€äºº</button>
<button onclick="calculate()">è¨ˆç®—</button>
<button onclick="copyResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
<button onclick="downloadData()">ğŸ’¾ ä¸‹è¼‰ JSON</button>
<input type="file" id="uploadFile" style="display:none" onchange="uploadData(event)">
<button onclick="document.getElementById('uploadFile').click()">ğŸ“‚ ä¸Šå‚³ JSON</button>
</div>
<div class="result" id="detailResult"></div>
<div class="result" id="result"></div>
</div>

<script>
// æ–°å¢äººå“¡
function addPerson(name=''){
  const div=document.getElementById("inputs");
  const personDiv=document.createElement("div");
  personDiv.className="person";
  personDiv.innerHTML=`
    <div class="inputs">
      <input type="text" placeholder="åå­—" value="${name}">
      <button class="remove-btn" onclick="removePerson(this)">åˆªé™¤æ­¤äºº</button>
    </div>
    <div class="detail-inputs"></div>
    <button onclick="addDetail(this)">ï¼‹å¢åŠ æ˜ç´°</button>`;
  div.appendChild(personDiv);
}

function removePerson(btn){btn.closest('.person').remove();}

// æ–°å¢æ˜ç´°
function addDetail(btn, amount=0, note=''){
  const container=btn.parentElement.querySelector('.detail-inputs');
  const div=document.createElement('div');
  div.className='detail-input';
  div.innerHTML=`
    <input type="number" placeholder="é‡‘é¡" value="${amount}">
    <input type="text" placeholder="å‚™è¨»" value="${note}">
    <button class="remove-btn" onclick="removeDetail(this)">åˆªé™¤</button>`;
  container.appendChild(div);
}

function removeDetail(btn){btn.parentElement.remove();}

// è¨ˆç®—çµç®—æ¸…å–®
function calculate(){
  const persons=document.querySelectorAll('.person');
  const names=[], totals=[];
  let totalAll=0;
  persons.forEach(p=>{
    const name=p.querySelector('input[type=text]').value||'P';
    let sum=0;
    p.querySelectorAll('.detail-input').forEach(d=>sum+=Number(d.children[0].value)||0);
    names.push(name); totals.push(sum); totalAll+=sum;
  });
  const avg=totalAll/names.length;
  const balance=totals.map(t=>+(t-avg).toFixed(2));

  // ç´°é …æ˜ç´°è¡¨æ ¼
  let detailHtml=`<h3>ç´°é …æ˜ç´°</h3>`;
  persons.forEach((p,i)=>{
    detailHtml+=`<b>${names[i]}</b>`;
    const details=p.querySelectorAll('.detail-input');
    if(details.length>0){
      detailHtml+=`<table><tr><th>é‡‘é¡</th><th>å‚™è¨»</th></tr>`;
      details.forEach(d=>detailHtml+=`<tr><td>${Number(d.children[0].value).toFixed(2)}</td><td>${d.children[1].value}</td></tr>`);
      detailHtml+=`<tr><th>ç¸½è¨ˆ</th><th>${totals[i].toFixed(2)}</th></tr></table>`;
    }else detailHtml+='ï¼š0.00';
  });
  detailHtml+=`<p><b>ç¸½é‡‘é¡ï¼š</b>${totalAll.toFixed(2)} | <b>å¹³å‡æ¯äººï¼š</b>${avg.toFixed(2)}</p>`;
  document.getElementById("detailResult").innerHTML=detailHtml;

  // çµç®—
  let creditors=balance.map((b,i)=>[i,b]).filter(x=>x[1]>0);
  let debtors=balance.map((b,i)=>[i,-b]).filter(x=>x[1]>0);
  let result='=== çµç®—æ¸…å–® ===\n';
  let i=0,j=0;
  while(i<creditors.length && j<debtors.length){
    let [cid,cval]=creditors[i];
    let [did,dval]=debtors[j];
    let amount=Math.min(cval,dval);
    result+=`${names[did]} â ${names[cid]} : ${amount.toFixed(2)}\n`;
    creditors[i][1]-=amount; debtors[j][1]-=amount;
    if(creditors[i][1]<0.01)i++;
    if(debtors[j][1]<0.01)j++;
  }
  document.getElementById("result").innerText=result;
}

// è¤‡è£½çµæœ
function copyResult(){
  const text=document.getElementById("result").innerText;
  if(!text)return;
  navigator.clipboard.writeText(text).then(()=>alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"));
}

// ä¸‹è¼‰ JSON
function downloadData(){
  const persons=document.querySelectorAll('.person');
  const data=[];
  persons.forEach(p=>{
    const name=p.querySelector('input[type=text]').value;
    const details=[];
    p.querySelectorAll('.detail-input').forEach(d=>details.push({amount:d.children[0].value,note:d.children[1].value}));
    data.push({name,details});
  });
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='data.json';
  a.click();
}

// ä¸Šå‚³ JSON
function uploadData(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=JSON.parse(e.target.result);
    const container=document.getElementById("inputs");
    container.innerHTML='';
    if(data.length===0){
      ['A','B','C'].forEach(n=>addPerson(n));
    }else{
      data.forEach(p=>{
        addPerson(p.name);
        const personDiv=container.lastChild;
        p.details.forEach(d=>addDetail(personDiv.querySelector('button'),d.amount,d.note));
      });
    }
  };
  reader.readAsText(file);
}

// åˆå§‹åŒ–é è¨­ä¸‰äºº
window.onload=()=>['A','B','C'].forEach(n=>addPerson(n));
</script>
  <script>
const API_URL = "https://script.google.com/macros/s/XXXXXX/exec"; // æ›æˆä½ çš„ URL

// å­˜æª”
function saveToDrive(data) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.text())
  .then(msg => alert("å·²å­˜åˆ° Google Drive: " + msg));
}

// è®€æª”
function loadFromDrive() {
  fetch(API_URL)
    .then(res => res.json())
    .then(files => {
      console.log("æª”æ¡ˆåˆ—è¡¨ï¼š", files);
      alert("æ‰¾åˆ° " + files.length + " å€‹æª”æ¡ˆ");
    });
}
</script>
</body>
</html>
