<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>AA 分帳計算器（Google Drive 共用版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;margin:20px;background:#f9f9f9;}
h2{text-align:center;color:#333;}
.container{max-width:700px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
.person{border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:5px;}
.inputs,.detail-input{display:flex;gap:10px;margin-bottom:5px;}
input{flex:1;padding:5px;font-size:14px;}
button{padding:5px 10px;font-size:14px;cursor:pointer;border:none;border-radius:5px;background:#007bff;color:white;}
button:hover{background:#0056b3;}
.remove-btn{background:#dc3545;}
.remove-btn:hover{background:#a71d2a;}
.result{margin-top:15px;background:#f1f1f1;padding:10px;border-radius:5px;white-space:pre-line;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:5px;text-align:center;}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
</style>
</head>
<body>
<div class="container">
<h2>AA 分帳計算器（Google Drive 共用版）</h2>
<div id="inputs"></div>
<div class="controls">
<button onclick="addPerson()">＋增加一人</button>
<button onclick="calculate()">計算</button>
<button onclick="copyResult()">📋 複製結果</button>
<button onclick="downloadData()">💾 下載 JSON</button>
<input type="file" id="uploadFile" style="display:none" onchange="uploadData(event)">
<button onclick="document.getElementById('uploadFile').click()">📂 上傳 JSON</button>
</div>
<div class="result" id="detailResult"></div>
<div class="result" id="result"></div>
</div>

<script>
// 新增人員
function addPerson(name=''){
  const div=document.getElementById("inputs");
  const personDiv=document.createElement("div");
  personDiv.className="person";
  personDiv.innerHTML=`
    <div class="inputs">
      <input type="text" placeholder="名字" value="${name}">
      <button class="remove-btn" onclick="removePerson(this)">刪除此人</button>
    </div>
    <div class="detail-inputs"></div>
    <button onclick="addDetail(this)">＋增加明細</button>`;
  div.appendChild(personDiv);
}

function removePerson(btn){btn.closest('.person').remove();}

// 新增明細
function addDetail(btn, amount=0, note=''){
  const container=btn.parentElement.querySelector('.detail-inputs');
  const div=document.createElement('div');
  div.className='detail-input';
  div.innerHTML=`
    <input type="number" placeholder="金額" value="${amount}">
    <input type="text" placeholder="備註" value="${note}">
    <button class="remove-btn" onclick="removeDetail(this)">刪除</button>`;
  container.appendChild(div);
}

function removeDetail(btn){btn.parentElement.remove();}

// 計算結算清單
function calculate(){
  const persons=document.querySelectorAll('.person');
  const names=[], totals=[];
  let totalAll=0;
  persons.forEach(p=>{
    const name=p.querySelector('input[type=text]').value||'P';
    let sum=0;
    p.querySelectorAll('.detail-input').forEach(d=>sum+=Number(d.children[0].value)||0);
    names.push(name); totals.push(sum); totalAll+=sum;
  });
  const avg=totalAll/names.length;
  const balance=totals.map(t=>+(t-avg).toFixed(2));

  // 細項明細表格
  let detailHtml=`<h3>細項明細</h3>`;
  persons.forEach((p,i)=>{
    detailHtml+=`<b>${names[i]}</b>`;
    const details=p.querySelectorAll('.detail-input');
    if(details.length>0){
      detailHtml+=`<table><tr><th>金額</th><th>備註</th></tr>`;
      details.forEach(d=>detailHtml+=`<tr><td>${Number(d.children[0].value).toFixed(2)}</td><td>${d.children[1].value}</td></tr>`);
      detailHtml+=`<tr><th>總計</th><th>${totals[i].toFixed(2)}</th></tr></table>`;
    }else detailHtml+='：0.00';
  });
  detailHtml+=`<p><b>總金額：</b>${totalAll.toFixed(2)} | <b>平均每人：</b>${avg.toFixed(2)}</p>`;
  document.getElementById("detailResult").innerHTML=detailHtml;

  // 結算
  let creditors=balance.map((b,i)=>[i,b]).filter(x=>x[1]>0);
  let debtors=balance.map((b,i)=>[i,-b]).filter(x=>x[1]>0);
  let result='=== 結算清單 ===\n';
  let i=0,j=0;
  while(i<creditors.length && j<debtors.length){
    let [cid,cval]=creditors[i];
    let [did,dval]=debtors[j];
    let amount=Math.min(cval,dval);
    result+=`${names[did]} ➝ ${names[cid]} : ${amount.toFixed(2)}\n`;
    creditors[i][1]-=amount; debtors[j][1]-=amount;
    if(creditors[i][1]<0.01)i++;
    if(debtors[j][1]<0.01)j++;
  }
  document.getElementById("result").innerText=result;
}

// 複製結果
function copyResult(){
  const text=document.getElementById("result").innerText;
  if(!text)return;
  navigator.clipboard.writeText(text).then(()=>alert("已複製到剪貼簿！"));
}

// 下載 JSON
function downloadData(){
  const persons=document.querySelectorAll('.person');
  const data=[];
  persons.forEach(p=>{
    const name=p.querySelector('input[type=text]').value;
    const details=[];
    p.querySelectorAll('.detail-input').forEach(d=>details.push({amount:d.children[0].value,note:d.children[1].value}));
    data.push({name,details});
  });
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='data.json';
  a.click();
}

// 上傳 JSON
function uploadData(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=JSON.parse(e.target.result);
    const container=document.getElementById("inputs");
    container.innerHTML='';
    if(data.length===0){
      ['A','B','C'].forEach(n=>addPerson(n));
    }else{
      data.forEach(p=>{
        addPerson(p.name);
        const personDiv=container.lastChild;
        p.details.forEach(d=>addDetail(personDiv.querySelector('button'),d.amount,d.note));
      });
    }
  };
  reader.readAsText(file);
}

// 初始化預設三人
window.onload=()=>['A','B','C'].forEach(n=>addPerson(n));
</script>
  <script>
const API_URL = "https://script.google.com/macros/s/XXXXXX/exec"; // 換成你的 URL

// 存檔
function saveToDrive(data) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.text())
  .then(msg => alert("已存到 Google Drive: " + msg));
}

// 讀檔
function loadFromDrive() {
  fetch(API_URL)
    .then(res => res.json())
    .then(files => {
      console.log("檔案列表：", files);
      alert("找到 " + files.length + " 個檔案");
    });
}
</script>
</body>
</html>
